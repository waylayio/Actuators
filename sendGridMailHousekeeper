{
  "name": "sendGridMailHousekeeper",
  "version": "1.0.2",
  "type": "actuator",
  "script": "start()\n    .then(_ => send())\n    .catch(err => {\n        console.log(err)\n        send(new Error(`Sending the email failed with following error: ${err.message}`))\n    })\n    \nasync function start () {\n    const TO = await getSandboxProperty('to')\n    const sendgridKey = await getSandboxProperty('SENDGRID_KEY')\n    const message = await getSandboxProperty('message')\n    const subject = await getSandboxProperty('subject')\n    const from = await getSandboxProperty('from')\n    \n    const messageParsed = waylayUtil.template(options, message)\n    const subjectParsed = waylayUtil.template(options, subject)\n    \n    if (!waylayUtil.validateEmail(TO) || !waylayUtil.validateEmail(from)) throw new Error(`Emails are not valid: to=${TO}, from=${from}`)\n    \n    const emailMessage = {\n        html: messageParsed,\n        subject: subjectParsed,\n        from: from,\n        to: TO\n    }\n\n    const requestOptions = {\n      url: 'https://api.sendgrid.com/api/mail.send.json',\n      formData: emailMessage,\n      'auth': {\n            'bearer': sendgridKey \n        }\n    }\n\n    return requestP.post(requestOptions)\n}\n\nasync function getSandboxProperty (key, defaultValue) {\n    const vaultKeyStart = 'VAULT:'\n    \n    const enhancedProperty = waylayUtil.getProperty(options, key) || defaultValue || ''\n\n    if (_.isEmpty(enhancedProperty) || !enhancedProperty.startsWith(vaultKeyStart)) return enhancedProperty\n    \n    const vaultKey = enhancedProperty.replace(vaultKeyStart, '')\n    \n    return waylay.vault.get(vaultKey)\n        .then(res => {\n            console.log(`Successfully got key from vault ${vaultKey} -> ${res}`)\n            return res\n        })\n        .catch(err => {\n            console.error(`Failed to get property '${enhancedProperty}' from vault`, err)\n            throw err\n        })\n}",
  "metadata": {
    "author": "",
    "category": "Mail",
    "description": "SendGrid mail actuator.\nMessage and subject are parsed using waylayUtil.template function.\n\nInput parameters are:\n<ul>\n<li>from</li>\n<li>to</li>\n<li>message</li>\n<li>subject</li>\n</ul>\n\nActuator requires <strong>SENDGRID_KEY</strong> in the global settings\n",
    "documentationURL": "https://sendgrid.com/docs",
    "iconURL": "https://static.waylay.io/plugs/icons/sendgrid-128.png",
    "supportedStates": [],
    "requiredProperties": [
      "from",
      "to",
      "message",
      "subject",
      "SENDGRID_KEY"
    ],
    "requiredRawData": []
  }
}
