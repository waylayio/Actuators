{
  "name": "salesforceaddfeeditem",
  "version": "0.0.3",
  "type": "actuator",
  "script": "var props = options.requiredProperties;\nvar OAuthConsumerKey = options.globalSettings.SALESFORCE_CLIENTID;\nvar OAuthConsumerSecret = options.globalSettings.SALESFORCE_CLIENTSECRET;\nvar clientId = options.globalSettings.DASHBOARD_KEY;\nvar clientSecret = options.globalSettings.DASHBOARD_SECRET;\nvar dashboardDomain = options.globalSettings.DASHBOARD_DOMAIN;\n\nvar message = waylayUtil.template(options, props.message);\nvar profile = props.profile || waylayUtil.getResource(options);\n\n// Gets the token for salesforce\nvar getToken = function(callback) {\n    var options = {\n        url: \"https://\"+dashboardDomain+\"/api/token/salesforce/\" + profile,\n        auth: {\n            user: clientId,\n            password: clientSecret\n        }\n    };\n    try {\n        request(options, function(error, response, body) {\n            if (!error && response.statusCode == 200) {\n                var bodyJson = JSON.parse(body);\n                console.info(bodyJson);\n                callback(null, bodyJson);\n            } else {\n                callback(new Error(\"Calling salesforce api failed: \" + error + \" \" + body + options.url));\n            }   \n        });\n    } catch(err){\n        callback(new Error(\"Calling salesforce api failed: \" + err));\n    }\n};\n\n// Gets the feedurl for the news for the user.\nvar getFeedUrl = function(data, callback) {\n    var options = {\n        url: 'https://$instance.salesforce.com/services/data/v23.0/chatter/feeds/news/me'.replace('$instance', data.custom.instance),\n        auth: {\n            bearer: data.accessToken\n        }\n    };\n    \n    try {\n        request(options, function(error, response, body) {\n            if (!error && response.statusCode == 200) {\n                var bodyjson = JSON.parse(body);\n                console.info(bodyjson);\n                callback(null, bodyjson.feedItemsUrl);\n            } else {\n                callback(new Error(\"Calling salesforce api failed: \" + error + \" \" + body + options.url));\n            }\n        });\n    } catch (err) {\n        callback(new Error(\"Calling salesforce api failed: \" + err));\n    }\n};\n\n// Posts a feeditem on a given feed.\nvar postFeedItem = function(feedItemsUrl, authData, callback) {\n    var options = {\n        url: 'https://' + authData.custom.instance + '.salesforce.com/' + feedItemsUrl,\n        auth: {\n            bearer: authData.accessToken\n        },\n        json: {\n            body: {\n                messageSegments: [\n                    {\n                        type: \"Text\",\n                        text: message\n                    }\n                ]\n            }\n        }\n    };\n    \n    try {\n        request.post(options, function(error, response, body) {\n            if (!error && response.statusCode === 200) {\n                callback(null, body);\n            } else {\n                callback(new Error('Could not send new feeditem.'));\n            }\n        });\n    } catch (err) {\n        callback(new Error('Could not send new feeditem: ' + err + '.'));\n    }\n};\n\nif(clientId !== undefined && clientSecret !== undefined && dashboardDomain !== undefined && message !== undefined) {\n    getToken(function(errToken, token) {\n       if (errToken !== undefined) {\n           getFeedUrl(token, function(errFeedUrl, feedUrl) {\n              if (errFeedUrl !== undefined) {\n                  postFeedItem(feedUrl, token, function(err, data) {\n                     if (err !== undefined) {\n                         send();\n                     } else {\n                         send(err);\n                     }\n                  });\n              } else {\n                  send(errFeedUrl);\n              }\n           });\n       } else {\n           send(errToken);\n       }\n    });\n} else {\n    send(new Error('Missing properties'));\n}",
  "metadata": {
    "author": "",
    "category": "Salesforce",
    "description": "alesforce Add feeditem actuator\n\nAdds a new saleforce feetitem to the users news feed.",
    "iconURL": "https://raw.githubusercontent.com/waylayio/documentation/master/icons/salesforce.png",
    "supportedStates": [],
    "requiredProperties": [
      "message",
      "profile"
    ],
    "requiredRawData": []
  }
}