{
  "name": "createGoogleCalendarEntry",
  "version": "0.0.1",
  "type": "actuator",
  "script": "var calendarId = waylayUtil.getProperty(options, \"calendarId\")\nvar duration = parseInt(waylayUtil.getProperty(options, \"duration\") || 15)\nvar eventName = waylayUtil.getProperty(options, \"eventName\")\nvar message = waylayUtil.template(options, options.requiredProperties.message)\nvar dayOfWeek = waylayUtil.getProperty(options, \"dayOfWeek\") || 'now'\nvar hour = parseFloat(waylayUtil.getProperty(options, \"hour\"))\nvar timeZone = waylayUtil.getProperty(options, \"timeZone\") || \"Europe/Brussels\"\nvar user = waylayUtil.getProperty(options, \"user\") || \"organisation\"\n\nvar apiRoot = \"https://www.googleapis.com/calendar/v3/\"\n\nfunction createEventObject() {\n    var eventDate, endDate\n\n    if (dayOfWeek === 'now') {\n        eventDate = moment().tz(timeZone)\n        endDate = moment().tz(timeZone).add(duration, 'minutes')\n    } else {\n        eventDate = moment().tz(timeZone).day(parseDayOfWeek(dayOfWeek)).hour(hour).minutes(0).seconds(0)\n        endDate = moment().tz(timeZone).day(parseDayOfWeek(dayOfWeek)).hour(hour).minutes(0).seconds(0).add(duration, 'minutes')\n    \n        if (eventDate < moment()) {\n            eventDate.add(1, 'week')\n            endDate.add(1, 'week')\n        }\n    }\n    \n    return JSON.stringify({\n      start: {\n        dateTime: eventDate,\n        timeZone: timeZone\n      },\n      end: {\n        dateTime: endDate,\n        timeZone: timeZone\n      },\n      summary: eventName,\n      description: message\n    })\n}\n\nfunction parseDayOfWeek (day) {\n    switch (day) {\n        case 'today':\n            return moment().tz(timeZone).day()\n        case 'tomorrow':\n            return moment().tz(timeZone).day() + 1\n        default:\n            return day\n    }\n}\nwaylayUtil.getAuthTokens(options, user, \"googlecalendar\")\n.then(tokens => {\n    console.log(tokens)\n    requestP({\n        url: apiRoot + 'calendars/' + calendarId + '/events?alt=json',\n        method: 'POST',\n         auth:{\n            'bearer': tokens.access_token\n        },\n        json: JSON.parse(createEventObject())\n    })\n})\n.then(send)\n.catch(err =>{\n    send(new Error())\n})",
  "metadata": {
    "author": "Glenn Van Mele",
    "category": "Google",
    "description": "Actuator that let's you add events to your Google Calendar.\n\nSpecify the calendarId you want to add your event to.\nSpecify the duration of the event in minutes.\nSpecify the event name.\nSpecify the message\n\nIf <strong>dayOfWeek is skipped</strong>, a new calendar entry will be created at the time this actuator is executed.",
    "documentationURL": "https://developers.google.com/google-apps/calendar/overview",
    "iconURL": "https://static.waylay.io/plugs/icons/googleCalendar.png",
    "supportedStates": [],
    "requiredProperties": [
      "calendarId",
      "duration",
      "eventName",
      "timeZone",
      "message",
      "dayOfWeek",
      "hour"
    ],
    "requiredRawData": []
  }
}
